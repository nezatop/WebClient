@{
ViewData["Title"] = "Данные в реальном времени";
}
<h1>@ViewData["Title"]</h1>

<div class="row">
    <div class="col-md-8">
        <h3>Общий график датчиков</h3>
        <div style="width: 100%; margin: auto;">
            <canvas id="mainChart"></canvas> </div>
    </div>
    <div class="col-md-4">
        <h3>Текущие значения</h3>
        <ul class="list-group">
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Температура
                <span class="badge bg-primary rounded-pill" id="temp-value">--.- °C</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Влажность
                <span class="badge bg-primary rounded-pill" id="hum-value">-- %</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Освещенность
                <span class="badge bg-primary rounded-pill" id="light-value">-- %</span>
            </li>
        </ul>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // 1. Инициализация пустого графика
    const ctx = document.getElementById('mainChart'); // 👈 Используем новый ID
    const mainChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            // 👈 НАСТРАИВАЕМ 3 НАБОРА ДАННЫХ
            datasets: [
                {
                    label: 'Освещенность (%)',
                    data: [],
                    borderColor: 'rgb(255, 205, 86)', // Желтый
                    tension: 0.1,
                    yAxisID: 'yPercent' // 👈 Привязка к оси Y "yPercent"
                },
                {
                    label: 'Температура (°C)',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)', // Красный
                    tension: 0.1,
                    yAxisID: 'yTemp' // 👈 Привязка к оси Y "yTemp"
                },
                {
                    label: 'Влажность (%)',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)', // Синий
                    tension: 0.1,
                    yAxisID: 'yPercent' // 👈 Привязка к оси Y "yPercent"
                }]
        },
        options: {
            // 👈 НАСТРАИВАЕМ ДВЕ ОСИ Y
            scales: {
                yPercent: { // Ось для % (Освещенность, Влажность)
                    type: 'linear',
                    position: 'left',
                    min: 0,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Проценты (%)'
                    }
                },
                yTemp: { // Ось для °C (Температура)
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Температура (°C)'
                    },
                    // Не показывать сетку от этой оси, чтобы не было мешанины
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });

    // 2. Настройка SignalR-соединения (без изменений)
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/dataHub")
        .configureLogging(signalR.LogLevel.Information)
        .build();

    // 3. 👈 Обновленная функция для обновления ВСЕХ данных
    function addDataToChart(label, light, temp, humidity) {
        mainChart.data.labels.push(label);

        mainChart.data.datasets[0].data.push(light);     // Данные для Освещенности
        mainChart.data.datasets[1].data.push(temp);      // Данные для Температуры
        mainChart.data.datasets[2].data.push(humidity);  // Данные для Влажности

        // Ограничим график 20-ю точками
        if (mainChart.data.labels.length > 20) {
            mainChart.data.labels.shift();
            // Удаляем старые данные из КАЖДОГО набора
            mainChart.data.datasets.forEach(dataset => {
                dataset.data.shift();
            });
        }

        mainChart.update();
    }

    // 4. 👈 УДАЛЯЕМ старый обработчик "ReceiveNewMeasurement"
    // Он нам больше не нужен, т.к. "ReceiveEnvData" содержит ВСЕ данные.
    // connection.on("ReceiveNewMeasurement", ...);

    // 5. 👈 ОБНОВЛЯЕМ обработчик "ReceiveEnvData", чтобы он делал ВСЮ работу
    connection.on("ReceiveEnvData", (data) => {
        console.log("New env data received:", data);

        // 1. Обновляем плашки (как и раньше)
        document.getElementById('temp-value').innerText = data.temperature.toFixed(1) + " °C";
        document.getElementById('hum-value').innerText = data.humidity.toFixed(0) + " %";
        document.getElementById('light-value').innerText = data.light.toFixed(0) + " %";

        // 2. Обновляем график
        // (Мы не получаем метку времени от ESP, поэтому просто берем
        // текущее время клиента для метки на оси X)
        const time = new Date().toLocaleTimeString();

        addDataToChart(time, data.light, data.temperature, data.humidity);
    });

    // 6. Запуск соединения (без изменений)
    async function start() {
        try {
            await connection.start();
            console.log("SignalR Connected.");
        } catch (err) {
            console.log(err);
            setTimeout(start, 5000);
        }
    };

    connection.onclose(async () => {
        await start();
    });

    start();

</script>
}